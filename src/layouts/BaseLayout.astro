---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import AnnouncementBanner from '../components/AnnouncementBanner.astro';
import CodeOfConduct from '../components/CodeOfConduct.astro';

// Import brand settings from Keystatic (if exists)
let brandColors = {
  rust: '#B94237',
  limestone: '#D0D96F',
  manatee: '#84BABF',
  coral: '#D89B92',
  surf: '#0B4F6C',
  deepWater: '#073447',
  milkweed: '#F2F3AE',
  graphite: '#39393B',
  sand: '#FAF9F5',
};

let announcement = {
  enabled: false,
  text: '',
  linkText: '',
  linkUrl: '',
  backgroundColor: 'rust',
};

type AnnouncementBannerColor = 'rust' | 'manatee' | 'limestone' | 'graphite';
const validAnnouncementColors = new Set<AnnouncementBannerColor>([
  'rust',
  'manatee',
  'limestone',
  'graphite',
]);

// Try to load brand settings from content (graceful fallback)
try {
  const brandFile = await import('../content/brand.json').catch(() => null);
  if (brandFile?.default?.colors) {
    brandColors = { ...brandColors, ...brandFile.default.colors };
  }
} catch (e) {
  // Use defaults
}

// Try to load announcement settings
try {
  const announcementFile = await import('../content/announcement.json').catch(() => null);
  if (announcementFile?.default) {
    announcement = { ...announcement, ...announcementFile.default };
  }
} catch (e) {
  // Use defaults
}

// Try to load business info for portal preconnect
let portalBaseUrl = 'https://portal.climbtheknot.com';
try {
  const biFile = await import('../content/business-info.json').catch(() => null);
  if (biFile?.default?.portal?.baseUrl) {
    portalBaseUrl = biFile.default.portal.baseUrl;
  }
} catch (e) {
  // Use default
}

interface Props {
  title: string;
  description?: string;
  isHome?: boolean;
}

const { title, description = 'The Knot Climbing Gym - Gainesville\'s premier climbing facility', isHome = false } = Astro.props;
const announcementBackgroundColor = validAnnouncementColors.has(announcement.backgroundColor as AnnouncementBannerColor)
  ? (announcement.backgroundColor as AnnouncementBannerColor)
  : 'rust';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/png" href="/images/logos/favicon-32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/logos/favicon-48.png" sizes="48x48" />
    <title>{title} | The Knot Climbing Gym</title>

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href={portalBaseUrl} crossorigin />

    <!-- Preload only the most critical heading font file -->
    <link rel="preload" href="/fonts/Uniform-Black.otf" as="font" type="font/otf" crossorigin />

    <!-- Inject brand colors as CSS variables -->
    <style define:vars={{
      'color-rust': brandColors.rust,
      'color-limestone': brandColors.limestone,
      'color-manatee': brandColors.manatee,
      'color-coral': brandColors.coral,
      'color-surf': brandColors.surf,
      'color-deep-water': brandColors.deepWater,
      'color-milkweed': brandColors.milkweed,
      'color-graphite': brandColors.graphite,
      'color-sand': brandColors.sand,
    }}>
      :root {
        --color-rust: var(--color-rust);
        --color-limestone: var(--color-limestone);
        --color-manatee: var(--color-manatee);
        --color-coral: var(--color-coral);
        --color-surf: var(--color-surf);
        --color-deep-water: var(--color-deep-water);
        --color-milkweed: var(--color-milkweed);
        --color-graphite: var(--color-graphite);
        --color-sand: var(--color-sand);
      }
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    {announcement.enabled && (
      <AnnouncementBanner
        text={announcement.text}
        linkText={announcement.linkText}
        linkUrl={announcement.linkUrl}
        backgroundColor={announcementBackgroundColor}
      />
    )}

    <Header isHome={isHome} showAnnouncement={announcement.enabled} />

    <main id="main-content">
      <slot />
    </main>

    <CodeOfConduct />

    <Footer />
  </body>
</html>
