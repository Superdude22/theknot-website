---
import BaseLayout from '../layouts/BaseLayout.astro';
import ShopPageClient from '../components/ShopPageClient.tsx';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const products = await getCollection('products');
const sortedProducts = products.sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const shopPathCandidates = [
  path.join(process.cwd(), 'src/content/pages/shop.json'),
  path.join(process.cwd(), 'src/content/pages/shop/index.json'),
];
const shopPath =
  shopPathCandidates.find((candidatePath) => fs.existsSync(candidatePath)) ||
  shopPathCandidates[0];

let shopPage: {
  hero?: {
    headline?: string;
    backgroundImage?: string;
    backgroundImageLibraryPath?: string;
  };
};

try {
  shopPage = JSON.parse(fs.readFileSync(shopPath, 'utf-8'));
} catch {
  shopPage = {
    hero: {
      headline: 'SHOP',
      backgroundImage: '/images/canva-final/canva-hills-background.jpg',
    },
  };
}

const toPublicUrl = (libraryPath?: string) =>
  libraryPath && libraryPath.startsWith('public/')
    ? `/${libraryPath.slice('public/'.length)}`
    : undefined;

const heroContent = shopPage.hero || {};
const heroImage =
  toPublicUrl(heroContent.backgroundImageLibraryPath) ||
  heroContent.backgroundImage ||
  '/images/canva-final/canva-hills-background.jpg';
---

<BaseLayout title="Shop">
  <main class="shop-page">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-background">
        <img src={heroImage} alt="" class="hero-bg-image" loading="eager" fetchpriority="high" decoding="async" />
      </div>

      <div class="hero-content">
        <h1 class="hero-headline">{heroContent.headline || 'SHOP'}</h1>
      </div>
    </section>

    <!-- Client-side interactive content -->
    <ShopPageClient client:load products={sortedProducts} />
  </main>
</BaseLayout>

<style>
  .shop-page {
    min-height: 100vh;
    background: #fff;
  }

  /* Hero Section */
  .hero-section {
    position: relative;
    height: 50vh;
    min-height: 400px;
    overflow: hidden;
  }

  .hero-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .hero-bg-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .hero-content {
    position: absolute;
    bottom: 15%;
    right: 8%;
    z-index: 2;
  }

  .hero-headline {
    font-family: 'Zing Rust', 'Impact', sans-serif;
    font-size: 72px;
    font-weight: 900;
    color: #fff;
    text-transform: uppercase;
    margin: 0;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hero-section {
      height: 40vh;
      min-height: 300px;
    }

    .hero-headline {
      font-size: 42px;
    }

    .hero-content {
      bottom: 10%;
      right: 5%;
    }
  }
</style>
