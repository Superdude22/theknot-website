---
import BaseLayout from '../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

const amenitiesFallback: Array<{
  title: string;
  description: string;
  imageLabel: string;
  image?: string;
  imageLibraryPath?: string;
}> = [
  {
    title: 'BOULDERING',
    description: 'Our bouldering area features a wide variety of problems for all skill levels. With regular route setting and a diverse range of holds, there\'s always something new to try.',
    imageLabel: 'Pic of bouldering',
  },
  {
    title: 'TOP-ROPE CLIMBING',
    description: 'Experience the thrill of climbing to new heights with our top-rope walls. Our auto-belays and lead walls provide challenges for climbers of every ability.',
    imageLabel: 'Pic of staff belay/top-roping',
  },
  {
    title: 'TRAINING AREA',
    description: 'Take your climbing to the next level with our dedicated training area. From hangboards to campus boards, we have the tools you need to build strength and improve technique.',
    imageLabel: 'Training area pic',
  },
  {
    title: 'YOGA STUDIO',
    description: 'Complement your climbing with yoga! Our studio offers classes designed to improve flexibility, balance, and mental focus — all key components of climbing performance.',
    imageLabel: 'Pic of yoga class',
  },
  {
    title: 'GEAR SHOP',
    description: 'Find everything you need right here at The Knot. From shoes to chalk bags, our pro shop stocks quality climbing gear and branded merchandise.',
    imageLabel: 'Gear shop pic',
  },
  {
    title: 'COMMUNITY EVENTS',
    description: 'From competitions to clinics, movie nights to member meetups — there\'s always something happening at The Knot. Check our events page for the latest.',
    imageLabel: 'Community events pic',
  },
];

const amenitiesPathCandidates = [
  path.join(process.cwd(), 'src/content/pages/amenities.json'),
  path.join(process.cwd(), 'src/content/pages/amenities/index.json'),
];
const amenitiesPath =
  amenitiesPathCandidates.find((candidatePath) => fs.existsSync(candidatePath)) ||
  amenitiesPathCandidates[0];

let amenitiesPage: {
  hero?: {
    headline?: string;
    backgroundImage?: string;
    backgroundImageLibraryPath?: string;
  };
  sectionHeadline?: string;
  introText?: string;
  amenityCards?: {
    title?: string;
    description?: string;
    imageLabel?: string;
    image?: string;
    imageLibraryPath?: string;
  }[];
  ctaText?: string;
  ctaButtons?: { text?: string; url?: string }[];
};

try {
  amenitiesPage = JSON.parse(fs.readFileSync(amenitiesPath, 'utf-8'));
} catch {
  amenitiesPage = {
    hero: {
      headline: 'AMENITIES',
      backgroundImage: '/images/canva-final/canva-hills-background.jpg',
    },
    sectionHeadline: 'MORE THAN JUST CLIMBING',
    introText: 'Whether you\'re here to crush a new boulder problem, train for your next outdoor adventure, or just hang out with the community, The Knot has something for everyone.',
    amenityCards: amenitiesFallback.map((card) => ({
      ...card,
      image: '/images/canva-final/canva-hills-background.jpg',
    })),
    ctaText: 'Don\'t just take our word for it — come see for yourself! Whether you\'re looking for a new way to stay active, a fun outing with friends, or a welcoming community to be part of, The Knot has something for everyone.',
    ctaButtons: [
      { text: 'CLASS SCHEDULE', url: 'https://portal.climbtheknot.com/gnv/calendar' },
      { text: 'BELAY CLASSES', url: 'https://portal.climbtheknot.com/gnv/services/belay-class' },
    ],
  };
}

const toPublicUrl = (libraryPath?: string) =>
  libraryPath && libraryPath.startsWith('public/')
    ? `/${libraryPath.slice('public/'.length)}`
    : undefined;

const heroContent = amenitiesPage.hero || {};
const heroImage =
  toPublicUrl(heroContent.backgroundImageLibraryPath) ||
  heroContent.backgroundImage ||
  '/images/canva-final/canva-hills-background.jpg';
const amenitiesCards =
  Array.isArray(amenitiesPage.amenityCards) && amenitiesPage.amenityCards.length > 0
    ? amenitiesPage.amenityCards
    : amenitiesFallback;
const ctaButtons =
  Array.isArray(amenitiesPage.ctaButtons) && amenitiesPage.ctaButtons.length > 0
    ? amenitiesPage.ctaButtons
    : [
        { text: 'CLASS SCHEDULE', url: 'https://portal.climbtheknot.com/gnv/calendar' },
        { text: 'BELAY CLASSES', url: 'https://portal.climbtheknot.com/gnv/services/belay-class' },
      ];
const introText = amenitiesPage.introText || '';
const ctaText = amenitiesPage.ctaText || '';

const cardRows: typeof amenitiesCards[] = [];
for (let index = 0; index < amenitiesCards.length; index += 3) {
  cardRows.push(amenitiesCards.slice(index, index + 3));
}

const labelPositionClasses = ['left', 'center', 'right'] as const;
---
<BaseLayout title="Amenities">
  <!-- Hero Section with design slide background -->
  <section class="hero-section">
    <div class="hero-background">
      <img
        src={heroImage}
        alt="Amenities hero background"
      />
    </div>

    <div class="hero-content">
      <h1 class="hero-headline">{heroContent.headline || 'AMENITIES'}</h1>
    </div>

    <!-- Video placeholder in top right -->
    <div class="hero-video-placeholder">
      <div class="video-box">
        <span class="video-label">Video of gym tour</span>
      </div>
    </div>
  </section>

  <!-- More Than Just Climbing Section -->
  <section class="amenities-grid-section">
    <h2 class="section-heading">{amenitiesPage.sectionHeadline || 'MORE THAN JUST CLIMBING'}</h2>

    {introText && (
      <p class="section-intro">{introText}</p>
    )}

    {cardRows.map((row, rowIndex) => (
      <div class={`amenities-grid ${rowIndex === cardRows.length - 1 ? 'row-2' : ''}`}>
        {row.map((amenity, amenityIndex) => {
          const cardImage = toPublicUrl(amenity.imageLibraryPath) || amenity.image;
          const labelPosition = labelPositionClasses[amenityIndex % labelPositionClasses.length];
          return (
            <div class="amenity-card">
              <div class="card-image">
                {cardImage ? (
                  <img
                    src={cardImage}
                    alt={amenity.imageLabel || amenity.title || 'Amenity image'}
                    class="amenity-image"
                    loading="lazy"
                    decoding="async"
                  />
                ) : (
                  <div class="placeholder-bg">
                    <div class="placeholder-sky"></div>
                    <div class="placeholder-clouds">
                      <div class="cloud cloud-left"></div>
                      <div class="cloud cloud-right"></div>
                    </div>
                    <div class="placeholder-hills">
                      <div class="hill hill-back"></div>
                      <div class="hill hill-front"></div>
                    </div>
                  </div>
                )}
                <div class={`card-label label-${labelPosition}`}>
                  <span>{amenity.imageLabel || 'Amenity image'}</span>
                </div>
              </div>
              <div class="card-content">
                <h3 class="card-title">{amenity.title}</h3>
                <p class="card-description">{amenity.description}</p>
              </div>
            </div>
          );
        })}
      </div>
    ))}

    {ctaText && (
      <p class="section-cta-text">{ctaText}</p>
    )}

    <!-- CTA Buttons -->
    <div class="cta-row">
      {ctaButtons.map((button) => (
        <a
          href={button.url || '#'}
          target={(button.url || '').startsWith('http') ? '_blank' : undefined}
          rel={(button.url || '').startsWith('http') ? 'noopener noreferrer' : undefined}
          class="cta-button"
        >
          {button.text || 'LEARN MORE'}
        </a>
      ))}
    </div>
  </section>

</BaseLayout>

<style>
  /* Hero Section */
  .hero-section {
    position: relative;
    height: 50vh;
    overflow: hidden;
  }

  .hero-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .hero-background img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center bottom;
  }

  .hero-content {
    position: absolute;
    bottom: 30px;
    right: 5%;
    z-index: 10;
  }

  .hero-headline {
    font-family: var(--font-display);
    font-size: 64px;
    font-weight: 900;
    color: white;
    text-transform: uppercase;
    margin: 0;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    letter-spacing: 2px;
  }

  .hero-video-placeholder {
    position: absolute;
    top: 60px;
    right: 40px;
    z-index: 10;
  }

  .video-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--color-rust);
    padding: 16px 20px;
    border: 3px solid black;
    min-width: 120px;
  }

  .video-label {
    font-family: var(--font-body);
    font-size: 12px;
    color: white;
    text-align: center;
  }

  /* Section Heading */
  .section-heading {
    font-family: var(--font-heading);
    font-size: 36px;
    font-weight: 900;
    color: black;
    text-align: center;
    text-transform: uppercase;
    margin: 0 0 40px 0;
  }

  /* Amenities Grid Section */
  .amenities-grid-section {
    padding: 60px 5%;
    background: white;
  }

  .amenities-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    max-width: 1000px;
    margin: 0 auto 24px;
  }

  .row-2 {
    margin-bottom: 40px;
  }

  /* Amenity Card */
  .amenity-card {
    position: relative;
  }

  .card-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    border: 3px solid black;
  }

  .amenity-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .placeholder-bg {
    position: relative;
    width: 100%;
    height: 100%;
    background: url('/images/canva-final/canva-hills-background.jpg') center/cover no-repeat;
  }

  .placeholder-sky {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 70%;
    background: linear-gradient(to bottom, #D6EEF5 0%, #D6EEF5 100%);
  }

  .placeholder-clouds {
    position: absolute;
    top: 15%;
    left: 0;
    right: 0;
    height: 30%;
  }

  .cloud {
    position: absolute;
    background: white;
    border-radius: 50%;
  }

  .cloud::before,
  .cloud::after {
    content: '';
    position: absolute;
    background: white;
    border-radius: 50%;
  }

  .cloud-left {
    width: 50px;
    height: 20px;
    top: 20%;
    left: 15%;
  }

  .cloud-left::before {
    width: 25px;
    height: 25px;
    top: -12px;
    left: 8px;
  }

  .cloud-left::after {
    width: 30px;
    height: 30px;
    top: -15px;
    left: 20px;
  }

  .cloud-right {
    width: 60px;
    height: 25px;
    top: 30%;
    right: 20%;
  }

  .cloud-right::before {
    width: 30px;
    height: 30px;
    top: -15px;
    left: 10px;
  }

  .cloud-right::after {
    width: 35px;
    height: 35px;
    top: -18px;
    left: 25px;
  }

  .placeholder-hills {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50%;
  }

  .hill {
    position: absolute;
    bottom: 0;
    border-radius: 50% 50% 0 0;
  }

  .hill-back {
    width: 120%;
    height: 80%;
    left: -10%;
    background: #8FB339;
  }

  .hill-front {
    width: 100%;
    height: 60%;
    left: 10%;
    background: #5C8A2B;
  }

  .card-label {
    position: absolute;
    bottom: 12px;
    background: var(--color-rust);
    padding: 8px 16px;
    border: 3px solid black;
  }

  .card-label span {
    font-family: var(--font-body);
    font-size: 11px;
    color: white;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .label-left {
    left: 12px;
  }

  .label-center {
    left: 50%;
    transform: translateX(-50%);
  }

  .label-right {
    right: 12px;
  }

  .card-content {
    padding: 16px 0;
  }

  .card-title {
    font-family: var(--font-heading);
    font-size: 16px;
    font-weight: 700;
    color: black;
    text-transform: uppercase;
    margin: 0 0 8px 0;
    line-height: 1.2;
  }

  .card-description {
    font-family: var(--font-body);
    font-size: 13px;
    color: #666;
    line-height: 1.5;
    margin: 0;
  }

  /* CTA Row */
  .cta-row {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-top: 32px;
  }

  .cta-button {
    display: inline-block;
    min-width: 180px;
    padding: 14px 32px;
    text-align: center;
    background: var(--color-rust);
    color: white;
    font-family: var(--font-body);
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .cta-button:hover {
    opacity: 0.9;
  }

  /* Intro & CTA text paragraphs */
  .section-intro {
    font-family: var(--font-body);
    font-size: 16px;
    color: #444;
    line-height: 1.7;
    text-align: center;
    max-width: 760px;
    margin: 0 auto 40px;
  }

  .section-cta-text {
    font-family: var(--font-body);
    font-size: 16px;
    color: #444;
    line-height: 1.7;
    text-align: center;
    max-width: 760px;
    margin: 40px auto 0;
  }

  .placeholder-sky,
  .placeholder-clouds,
  .placeholder-hills {
    display: none;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .hero-section {
      height: 220px;
    }

    .hero-headline {
      font-size: 36px;
    }

    .hero-content {
      bottom: 20px;
      right: 5%;
    }

    .hero-video-placeholder {
      top: 40px;
      right: 20px;
    }

    .video-box {
      padding: 12px 16px;
      min-width: 100px;
    }

    .section-heading {
      font-size: 24px;
      margin-bottom: 32px;
    }

    .amenities-grid-section {
      padding: 40px 5%;
    }

    .amenities-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .card-label {
      left: 50% !important;
      right: auto !important;
      transform: translateX(-50%);
    }

    .cta-row {
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .cta-button {
      width: 100%;
      max-width: 240px;
    }

    .section-intro,
    .section-cta-text {
      font-size: 14px;
    }
  }
</style>

