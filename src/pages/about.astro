---
import BaseLayout from '../layouts/BaseLayout.astro';
import TeamMemberCard from '../components/TeamMemberCard.astro';
import Accordion from '../components/Accordion.tsx';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

// Load about page content from Keystatic
let aboutPage;
try {
  const aboutPathCandidates = [
    path.join(process.cwd(), 'src/content/pages/about/index.json'),
    path.join(process.cwd(), 'src/content/pages/about.json'),
  ];
  const aboutPagePath =
    aboutPathCandidates.find((candidatePath) => fs.existsSync(candidatePath)) ||
    aboutPathCandidates[0];
  const raw = fs.readFileSync(aboutPagePath, 'utf-8');
  aboutPage = JSON.parse(raw);
} catch (e) {
  // Fallback if file doesn't exist
  aboutPage = {
    hero: { headline: 'ABOUT & FAQ', backgroundImage: '/images/canva-final/about-building-facade.jpg' },
    coreValuesHeadline: 'CORE VALUES',
    coreValues: [],
    teamSections: {
      ownersHeadline: 'OWNERS & MANAGERS',
      coordinatorsHeadline: 'COORDINATORS',
      staffHeadline: 'DESK STAFF & INSTRUCTORS',
    },
    faqHeadline: 'FREQUENTLY ASKED QUESTIONS',
    faqItems: [],
    feedbackButtons: [],
  };
}

// Load team members from Keystatic
const allTeamMembers = await getCollection('team');
const toPublicUrl = (libraryPath?: string) =>
  libraryPath && libraryPath.startsWith('public/')
    ? `/${libraryPath.slice('public/'.length)}`
    : undefined;

// Sort team members by order and categorize
const sortedTeam = allTeamMembers.sort((a, b) => (a.data.order || 99) - (b.data.order || 99));
const getTeamGroup = (member: (typeof allTeamMembers)[number]) => {
  const explicitGroup = member.data.teamGroup;
  if (explicitGroup === 'leadership' || explicitGroup === 'coordinator' || explicitGroup === 'staff') {
    return explicitGroup;
  }

  // Backward-compatible fallback for pre-migration content
  if (member.data.isLeadership) return 'leadership';
  if ((member.data.role || '').trim().toLowerCase() === 'coordinator') return 'coordinator';
  return 'staff';
};

const ownersManagers = sortedTeam
  .filter(member => getTeamGroup(member) === 'leadership')
  .map(member => ({
    name: member.data.name,
    title: member.data.role,
    image: toPublicUrl(member.data.photoLibraryPath) || member.data.photo,
  }));

const coordinators = sortedTeam
  .filter(member => getTeamGroup(member) === 'coordinator')
  .map(member => ({
    name: member.data.name,
    title: member.data.role,
    image: toPublicUrl(member.data.photoLibraryPath) || member.data.photo,
  }));

const deskStaff = sortedTeam
  .filter(member => getTeamGroup(member) === 'staff')
  .map(member => ({
    name: member.data.name,
    title: member.data.role,
    image: toPublicUrl(member.data.photoLibraryPath) || member.data.photo,
  }));

// Get core values and FAQ from aboutPage singleton
const coreValuesItems = aboutPage?.coreValues || [];
const faqItems = aboutPage?.faqItems || [];
const aboutHeroFromCms = toPublicUrl(aboutPage?.hero?.backgroundImageLibraryPath) || aboutPage?.hero?.backgroundImage;
const aboutHeroImage =
  aboutHeroFromCms === '/images/canva-final/about-building-facade.jpg'
    ? '/images/canva-final/about-building-facade-1366.jpg'
    : (aboutHeroFromCms || '/images/canva-final/about-building-facade-1366.jpg');
---

<BaseLayout title="About & FAQ">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-background">
      <div class="hero-overlay"></div>
      <img
        src={aboutHeroImage}
        alt="The Knot Climbing Gym building exterior"
        class="hero-image"
        loading="eager"
        fetchpriority="high"
        decoding="async"
        width="1366"
        height="911"
      />
    </div>
    <div class="hero-content">
      <h1 class="hero-headline">
        {aboutPage?.hero?.headline || 'ABOUT & FAQ'}
      </h1>
    </div>
  </section>

  <!-- About Intro Section -->
  {aboutPage?.aboutIntro && (
    <section class="about-intro-section">
      <p class="about-intro-text">{aboutPage.aboutIntro}</p>
    </section>
  )}

  <!-- Core Values Section -->
  <section class="core-values-section">
    <h2 class="section-heading">{aboutPage?.coreValuesHeadline || 'CORE VALUES'}</h2>
    <div class="accordion-container">
      <Accordion client:visible items={coreValuesItems} />
    </div>
  </section>

  <!-- Meet The Team Section -->
  {(aboutPage?.meetTheTeamHeadline || aboutPage?.meetTheTeamIntro) && (
    <section class="meet-the-team-section">
      {aboutPage?.meetTheTeamHeadline && (
        <h2 class="meet-the-team-heading">{aboutPage.meetTheTeamHeadline}</h2>
      )}
      {aboutPage?.meetTheTeamIntro && (
        <p class="meet-the-team-intro">{aboutPage.meetTheTeamIntro}</p>
      )}
    </section>
  )}

  <!-- Owners & Managers Section -->
  <section class="team-section owners-section">
    <h2 class="team-section-heading">{aboutPage?.teamSections?.ownersHeadline || 'OWNERS & MANAGERS'}</h2>
    <div class="team-grid owners-grid">
      {ownersManagers.map((member) => (
        <TeamMemberCard
          name={member.name}
          title={member.title}
          image={member.image}
          filterType="blue-black"
        />
      ))}
    </div>
  </section>

  <!-- Coordinators Section -->
  <section class="team-section coordinators-section">
    <h2 class="team-section-heading">{aboutPage?.teamSections?.coordinatorsHeadline || 'COORDINATORS'}</h2>
    <div class="team-grid coordinators-grid">
      {coordinators.map((member) => (
        <TeamMemberCard
          name={member.name}
          title={member.title}
          image={member.image}
          filterType="grayscale"
        />
      ))}
    </div>
  </section>

  <!-- Desk Staff & Instructors Section -->
  <section class="team-section staff-section">
    <h2 class="team-section-heading staff-heading">{aboutPage?.teamSections?.staffHeadline || 'DESK STAFF & INSTRUCTORS'}</h2>
    <div class="team-grid staff-grid">
      {deskStaff.map((member) => (
        <TeamMemberCard
          name={member.name}
          title={member.title}
          image={member.image}
          filterType="grayscale"
        />
      ))}
    </div>
  </section>

  <!-- FAQ Section -->
  <section id="faq" class="faq-section">
    <h2 class="section-heading">{aboutPage?.faqHeadline || 'FREQUENTLY ASKED QUESTIONS'}</h2>
    {aboutPage?.faqIntro && (
      <p class="faq-intro-text">{aboutPage.faqIntro}</p>
    )}
    <div class="accordion-container">
      <Accordion client:visible items={faqItems} />
    </div>
    <div class="feedback-buttons">
      {aboutPage?.feedbackButtons?.map((button: { text: string; url: string }) => (
        <a
          href={button.url}
          target={button.url.startsWith('http') ? '_blank' : undefined}
          rel={button.url.startsWith('http') ? 'noopener noreferrer' : undefined}
          class="feedback-button"
        >
          {button.text}
        </a>
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .hero-section {
    position: relative;
    min-height: 50vh;
    width: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    overflow: hidden;
  }

  .hero-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: rgba(200, 150, 0, 0.6);
    z-index: 1;
  }

  .hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .hero-content {
    position: relative;
    z-index: 2;
    padding: 48px;
    padding-top: 120px;
  }

  .hero-headline {
    font-family: var(--font-heading, 'Zing Rust', sans-serif);
    font-size: 72px;
    font-weight: 900;
    color: #fff;
    line-height: 1.1;
    margin: 0;
    text-transform: uppercase;
    text-align: right;
  }

  .faq-link {
    color: #fff;
    text-decoration: none;
  }

  .faq-link:hover {
    text-decoration: underline;
  }

  .about-intro-section {
    padding: 48px 24px;
    background-color: #000;
    text-align: center;
  }

  .about-intro-text {
    max-width: 900px;
    margin: 0 auto;
    color: #fff;
    font-family: var(--font-body);
    font-size: 18px;
    line-height: 1.6;
  }

  .core-values-section {
    padding: 64px 24px;
    background-color: #000;
  }

  .section-heading {
    font-family: var(--font-heading, 'Zing Rust', sans-serif);
    font-size: 32px;
    font-weight: 900;
    color: #fff;
    text-transform: uppercase;
    text-align: center;
    margin: 0 0 40px 0;
    letter-spacing: 2px;
  }

  .accordion-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .meet-the-team-section {
    padding: 64px 24px 0;
    background-color: #fff;
    text-align: center;
  }

  .meet-the-team-heading {
    font-family: var(--font-heading, 'Zing Rust', sans-serif);
    font-size: 32px;
    font-weight: 900;
    color: #000;
    text-transform: uppercase;
    margin: 0 0 20px 0;
    letter-spacing: 2px;
  }

  .meet-the-team-intro {
    max-width: 800px;
    margin: 0 auto;
    color: #333;
    font-family: var(--font-body);
    font-size: 18px;
    line-height: 1.6;
  }

  .team-section {
    padding: 64px 24px;
    background-color: #fff;
  }

  .owners-section {
    padding-top: 80px;
  }

  .team-section-heading {
    font-family: var(--font-heading, 'Zing Rust', sans-serif);
    font-size: 24px;
    font-weight: 900;
    color: #9e4b45;
    text-transform: uppercase;
    margin: 0 0 40px 0;
    letter-spacing: 2px;
  }

  .staff-heading {
    text-align: left;
  }

  .team-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 24px;
  }

  .owners-grid {
    max-width: 1100px;
    margin: 0 auto;
  }

  .coordinators-grid {
    max-width: 1200px;
    margin: 0 auto;
  }

  .staff-grid {
    max-width: 1400px;
    margin: 0 auto;
    gap: 16px;
  }

  .faq-section {
    padding: 64px 24px;
    background-color: #000;
  }

  .faq-intro-text {
    max-width: 900px;
    margin: 0 auto 32px;
    color: #ccc;
    font-family: var(--font-body);
    font-size: 16px;
    line-height: 1.5;
    text-align: center;
  }

  .feedback-buttons {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-top: 48px;
  }

  .feedback-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 225px;
    height: 55px;
    font-family: var(--font-heading, 'Uniform Pro', sans-serif);
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .feedback-button:hover {
    opacity: 0.9;
  }

  .submit-btn {
    background-color: var(--color-manatee, #84BABF);
    color: #000;
  }

  .contact-btn {
    background-color: var(--color-manatee, #84BABF);
    color: #000;
  }

  @media (max-width: 768px) {
    .hero-section {
      min-height: 50vh;
    }

    .hero-content {
      padding: 24px;
      padding-top: 100px;
    }

    .hero-headline {
      font-size: 42px;
    }

    .about-intro-section {
      padding: 32px 16px;
    }

    .about-intro-text {
      font-size: 16px;
    }

    .core-values-section {
      padding: 48px 16px;
    }

    .section-heading {
      font-size: 24px;
      margin-bottom: 32px;
    }

    .meet-the-team-section {
      padding: 48px 16px 0;
    }

    .meet-the-team-heading {
      font-size: 24px;
    }

    .meet-the-team-intro {
      font-size: 16px;
    }

    .team-section {
      padding: 48px 16px;
    }

    .team-section-heading {
      font-size: 20px;
      margin-bottom: 32px;
    }

    .team-grid {
      gap: 16px;
    }

    .staff-grid {
      gap: 12px;
    }

    .faq-section {
      padding: 48px 16px;
    }

    .feedback-buttons {
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .feedback-button {
      width: 100%;
      max-width: 280px;
    }
  }
</style>
