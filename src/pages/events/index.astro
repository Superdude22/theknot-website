---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Accordion from '../../components/Accordion.tsx';
import { getCollection } from 'astro:content';
import fs from 'node:fs';
import path from 'node:path';

const hillsPlaceholder = '/images/canva-final/canva-hills-background.jpg';
const redpointEventsUrl = 'https://portal.climbtheknot.com/gnv/events';

// Load business info for events email
let eventsEmail = 'events@climbtheknot.com';
try {
  const biPath = path.join(process.cwd(), 'src/content/business-info.json');
  const raw = fs.readFileSync(biPath, 'utf-8');
  const parsed = JSON.parse(raw);
  if (parsed?.contact?.eventsEmail) eventsEmail = parsed.contact.eventsEmail;
} catch (e) {
  // Use default
}

function parseDate(value?: string): Date | null {
  if (!value) return null;
  const parsed = new Date(value);
  return Number.isNaN(parsed.getTime()) ? null : parsed;
}

function formatDate(value?: string): string {
  const parsed = parseDate(value);
  if (!parsed) return 'Date TBD';
  return parsed.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
}

const allEvents = (await getCollection('events')).sort((left, right) => {
  const leftDate = parseDate(left.data.date);
  const rightDate = parseDate(right.data.date);

  if (!leftDate && !rightDate) return 0;
  if (!leftDate) return 1;
  if (!rightDate) return -1;
  return leftDate.getTime() - rightDate.getTime();
});

const now = new Date();
now.setHours(0, 0, 0, 0);

const upcomingEvents = allEvents.filter((event) => {
  const eventDate = parseDate(event.data.date);
  return !eventDate || eventDate.getTime() >= now.getTime();
});

const pastEvents = allEvents.filter((event) => {
  const eventDate = parseDate(event.data.date);
  return !!eventDate && eventDate.getTime() < now.getTime();
});

const featuredEvent =
  upcomingEvents.find((event) => event.data.isFeatured) ??
  upcomingEvents[0] ??
  allEvents[0] ??
  null;

const toPublicUrl = (libraryPath?: string) =>
  libraryPath && libraryPath.startsWith('public/')
    ? `/${libraryPath.slice('public/'.length)}`
    : undefined;

const eventImage = (event: (typeof allEvents)[number]) =>
  toPublicUrl(event.data.imageLibraryPath) || event.data.image || hillsPlaceholder;

const eventTypeItems = [
  {
    title: 'BOULDERING ONLY',
    content:
      'Bouldering is climbing without ropes on shorter walls with thick crash pads below. Great for first-time climbers and larger group events.',
  },
  {
    title: 'TOP ROPE + BOULDERING',
    content:
      'Top rope events include harnesses and rope climbing lanes in addition to bouldering zones. Belay support requirements depend on group size.',
  },
  {
    title: 'STAFF BELAY',
    content:
      'Need belayers? The Knot can provide trained staff belayers for private and corporate events when scheduled in advance.',
  },
  {
    title: 'YOGA OR FITNESS CLASS',
    content:
      'Add yoga or fitness sessions to your event package. Availability depends on instructor schedules and gym staffing.',
  },
  {
    title: 'BELAY CLASS',
    content:
      'Belay classes can be added for groups that want certification as part of the event experience.',
  },
  {
    title: 'KIDS POLICIES',
    content:
      'Youth participants must follow age and supervision requirements. Contact staff for current youth policy details before booking.',
  },
];
---

<BaseLayout title="Events">
  <section class="hero-section">
    <img src={hillsPlaceholder} alt="" class="hero-bg" loading="eager" fetchpriority="high" decoding="async" />
    <h1 class="hero-title">EVENTS</h1>
  </section>

  <section class="next-event-section">
    <div class="next-event-grid">
      <div class="next-event-main">
        <h2 class="section-title">OUR NEXT EVENT</h2>
        {featuredEvent ? (
          <>
            <h3 class="event-title">{featuredEvent.data.title}</h3>
            <p class="event-meta">{formatDate(featuredEvent.data.date)} {featuredEvent.data.time ? `| ${featuredEvent.data.time}` : ''}</p>
            <p class="event-description">{featuredEvent.data.description ?? 'Details coming soon.'}</p>
          </>
        ) : (
          <p class="event-description">No upcoming events posted yet.</p>
        )}

        <a href={redpointEventsUrl} target="_blank" rel="noopener noreferrer" class="btn-secondary next-event-button">
          REGISTRATION & MORE INFO
        </a>
      </div>

      <img
        src={featuredEvent ? eventImage(featuredEvent) : hillsPlaceholder}
        alt={featuredEvent?.data.title || 'Event preview'}
        class="next-event-image"
      />
    </div>
  </section>

  <section class="calendar-section">
    <h2 class="section-title">EVENT CALENDAR</h2>
    <p class="section-subtext">We host events almost every month. Click any event to learn more.</p>

    <div class="calendar-grid">
      {upcomingEvents.length > 0 ? (
        upcomingEvents.map((event) => (
          <a href={`/events/${event.id}`} class="calendar-card">
            <img src={eventImage(event)} alt={event.data.title} class="calendar-card-image" loading="lazy" decoding="async" />
            <div class="calendar-card-body">
              <h3 class="calendar-card-title">{event.data.title}</h3>
              <p class="calendar-card-date">{formatDate(event.data.date)}</p>
            </div>
          </a>
        ))
      ) : (
        <p class="calendar-empty">No upcoming events yet.</p>
      )}
    </div>
  </section>

  {featuredEvent && (
    <section class="spotlight-section">
      <div class="spotlight-card">
        <img src={eventImage(featuredEvent)} alt={featuredEvent.data.title} class="spotlight-image" loading="lazy" decoding="async" />
        <div class="spotlight-content">
          <h2 class="section-title">{featuredEvent.data.title}</h2>
          <p class="spotlight-date">{formatDate(featuredEvent.data.date)} {featuredEvent.data.time ? `| ${featuredEvent.data.time}` : ''}</p>
          <p class="spotlight-description">{featuredEvent.data.description ?? 'Details coming soon.'}</p>
          <a href={`/events/${featuredEvent.id}`} class="btn-primary">REGISTRATION</a>
          <p class="spotlight-address">ADDRESS<br />619 S Main St</p>
        </div>
      </div>
    </section>
  )}

  <section class="group-events-section">
    <h2 class="section-title">GROUP EVENTS</h2>
    <p class="section-subtext">Host your next event with The Knot!</p>
    <h3 class="group-subtitle">EVENT TYPES & PRICING</h3>
    <Accordion items={eventTypeItems} client:visible />
    <p class="group-footnote">
      Group events must be scheduled at least three weeks in advance. Fill out our inquiry form or shoot us an email to learn more.
      Group event scheduling is subject to gym and staff availability.
    </p>
    <div class="group-buttons">
      <a
        href="https://form.asana.com/?k=event-request"
        target="_blank"
        rel="noopener noreferrer"
        class="btn-secondary"
      >
        EVENT REQUEST FORM
      </a>
      <a href={`mailto:${eventsEmail}`} class="btn-primary">CONTACT US</a>
    </div>
  </section>

  <section class="upending-section">
    <div class="upending-grid">
      <div>
        <h2 class="section-title">UPENDING PARKINSONS</h2>
        <p class="event-description">
          The Knot is partnering with Up ENDing Parkinsons to provide guided climbing sessions for people living with Parkinson&apos;s Disease.
          Anyone living with PD is welcome to climb, and family members are encouraged to join.
        </p>
        <p class="event-description"><strong>WEDNESDAYS 10AM - 11:30AM</strong></p>
        <p class="event-description">
          Admission, instruction, and rental gear are provided free of charge. No experience is required.
        </p>
        <a href="https://upendingparkinsons.org/" target="_blank" rel="noopener noreferrer" class="btn-secondary">
          REGISTER HERE
        </a>
      </div>
      <img src={hillsPlaceholder} alt="Event placeholder hills background" class="upending-image" loading="lazy" decoding="async" />
    </div>
  </section>

  {pastEvents.length > 0 && (
    <section class="past-events-section">
      <details>
        <summary class="section-title past-events-summary">PAST EVENTS ({pastEvents.length})</summary>
        <div class="calendar-grid">
          {pastEvents.map((event) => (
            <a href={`/events/${event.id}`} class="calendar-card calendar-card--past">
              <img src={eventImage(event)} alt={event.data.title} class="calendar-card-image" loading="lazy" decoding="async" />
              <div class="calendar-card-body">
                <h3 class="calendar-card-title">{event.data.title}</h3>
                <p class="calendar-card-date">{formatDate(event.data.date)}</p>
              </div>
            </a>
          ))}
        </div>
      </details>
    </section>
  )}
</BaseLayout>

<style>
  .hero-section {
    position: relative;
    height: 50vh;
    min-height: 350px;
    overflow: hidden;
  }

  .hero-bg {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .hero-title {
    position: absolute;
    right: 5%;
    bottom: 24px;
    margin: 0;
    color: #fff;
    font-family: var(--font-heading);
    font-size: clamp(36px, 6vw, 64px);
    font-weight: 900;
    text-transform: uppercase;
    line-height: 1;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
  }

  .next-event-section,
  .calendar-section,
  .spotlight-section,
  .group-events-section,
  .upending-section,
  .past-events-section {
    padding: 48px 24px;
    background: #000;
  }

  .calendar-section,
  .spotlight-section {
    background: #fff;
  }

  .section-title {
    margin: 0 0 12px;
    color: #fff;
    font-family: var(--font-heading);
    font-size: clamp(24px, 3.6vw, 44px);
    font-weight: 900;
    text-transform: uppercase;
    line-height: 1.1;
  }

  .calendar-section .section-title,
  .spotlight-section .section-title {
    color: #000;
  }

  .section-subtext {
    margin: 0 0 20px;
    color: #ddd;
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.5;
  }

  .calendar-section .section-subtext {
    color: #4d4d4d;
  }

  .next-event-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    gap: 24px;
    grid-template-columns: 1.2fr 1fr;
    align-items: center;
  }

  .event-title {
    margin: 0 0 8px;
    color: #fff;
    font-family: var(--font-heading);
    font-size: clamp(18px, 2.6vw, 32px);
    text-transform: uppercase;
  }

  .event-meta,
  .event-description {
    margin: 0 0 12px;
    color: #e8e8e8;
    font-family: var(--font-body);
    font-size: 15px;
    line-height: 1.6;
  }

  .next-event-image {
    width: 100%;
    aspect-ratio: 16 / 10;
    object-fit: cover;
    border-radius: 6px;
  }

  .next-event-button {
    margin-top: 16px;
    width: min(100%, 320px);
  }

  .calendar-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
  }

  .calendar-card {
    display: block;
    text-decoration: none;
    border: 1px solid #dadada;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    color: inherit;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .calendar-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
  }

  .calendar-card-image {
    width: 100%;
    aspect-ratio: 5 / 4;
    object-fit: cover;
    display: block;
  }

  .calendar-card-body {
    padding: 12px;
  }

  .calendar-card-title {
    margin: 0 0 4px;
    color: #000;
    font-family: var(--font-heading);
    font-size: 14px;
    text-transform: uppercase;
  }

  .calendar-card-date {
    margin: 0;
    color: #666;
    font-family: var(--font-body);
    font-size: 12px;
  }

  .calendar-empty {
    margin: 0;
    color: #4d4d4d;
    font-family: var(--font-body);
  }

  .spotlight-card {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    border: 1px solid #dadada;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
  }

  .spotlight-image {
    width: 100%;
    height: 100%;
    min-height: 260px;
    object-fit: cover;
  }

  .spotlight-content {
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .spotlight-date,
  .spotlight-description,
  .spotlight-address {
    margin: 0;
    color: #333;
    font-family: var(--font-body);
    line-height: 1.6;
  }

  .group-subtitle {
    margin: 0 0 14px;
    color: #84babf;
    font-family: var(--font-heading);
    font-size: 15px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .group-footnote {
    margin: 18px 0 20px;
    color: #cfcfcf;
    font-family: var(--font-body);
    font-size: 14px;
    line-height: 1.6;
  }

  .group-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .upending-grid {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    gap: 24px;
    grid-template-columns: 1fr 1fr;
    align-items: center;
  }

  .upending-image {
    width: 100%;
    aspect-ratio: 16 / 9;
    object-fit: cover;
    border-radius: 6px;
  }

  .past-events-summary {
    cursor: pointer;
    list-style: none;
  }

  .past-events-summary::-webkit-details-marker {
    display: none;
  }

  .calendar-card--past {
    opacity: 0.75;
  }

  @media (max-width: 900px) {
    .next-event-grid,
    .spotlight-card,
    .upending-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
